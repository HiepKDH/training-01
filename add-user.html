<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Add User</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
            crossorigin="anonymous"
        />
        <link rel="stylesheet" href="./assets/css/reset.css" />
        <link rel="stylesheet" href="./assets/css/add-user.css" />
    </head>
    <body>
        <div class="add-user-container">
            <form
                action=""
                method="POST"
                class="form__add-user"
                id="form-add-user"
            >
                <h3 class="add-user__title">Thêm nhân viên mới</h3>
                <div class="row">
                    <div class="col-sm-6 col-xl-4">
                        <div class="form-group">
                            <label for="username">Tên người dùng:</label>
                            <input
                                type="text"
                                id="username"
                                name="username"
                                class="form-control"
                                placeholder="VD: hiepkd"
                                required
                            />
                            <span class="form-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="password" class="form-label"
                                >Mật khẩu:</label
                            >
                            <input
                                id="password"
                                name="password"
                                type="password"
                                class="form-control"
                            />
                            <span class="form-message"></span>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xl-4">
                        <div class="form-group">
                            <label for="name">Tên đầy đủ:</label>
                            <input
                                type="text"
                                id="name"
                                name="name"
                                class="form-control"
                                placeholder="VD: Khuất Đình Hiệp"
                                required
                            />
                            <span class="form-message"></span>
                        </div>
                        <div class="form-group">
                            <label
                                for="password_confirmation"
                                class="form-label"
                                >Nhập lại mật khẩu:</label
                            >
                            <input
                                id="password_confirmation"
                                name="password_confirmation"
                                type="password"
                                class="form-control"
                            />
                            <span class="form-message"></span>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xl-4">
                        <div class="form-group">
                            <label for="email">Địa chỉ email:</label>
                            <input
                                type="email"
                                id="email"
                                name="email"
                                class="form-control"
                                placeholder="VD: khuatdinhhiep@gmail.com"
                            />
                            <span class="form-message"></span>
                        </div>

                        <div class="form-group">
                            <label for="phone_number">Số điện thoại:</label>
                            <input
                                type="tel"
                                id="phone_number"
                                name="phone_number"
                                class="form-control"
                                placeholder="VD: 0987654321"
                            />
                            <span class="form-message"></span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group col-sm-6 col-xl-4">
                        <label for="is_active">Trạng thái:</label>
                        <select id="is_active" name="is_active" required>
                            <option value="0">Không hoạt động</option>
                            <option value="1">Hoạt động</option>
                        </select>
                        <span class="form-message"></span>
                    </div>
                    <div class="form-group col-sm-6 col-xl-4">
                        <label for="birth_date">Ngày sinh:</label>
                        <input
                            type="date"
                            id="birth_date"
                            name="birth_date"
                            class="form-control"
                        />
                        <span class="form-message"></span>
                    </div>
                    <div class="form-group col-sm-6 col-xl-4">
                        <label for="role_id">Vai trò:</label>
                        <select id="role_id" name="role_id">
                            <option value="1">User</option>
                            <option value="2">Admin</option>
                        </select>
                        <span class="form-message"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Giới tính:</label>
                    <input type="radio" id="male" name="gender" value="0" />
                    <label for="male">Nam</label>
                    <input type="radio" id="female" name="gender" value="1" />
                    <label for="female">Nữ</label>
                    <input type="radio" id="other" name="gender" value="" />
                    <label for="other">Khác</label>
                    <span class="form-message"></span>
                </div>

                <div class="form-group">
                    <label for="description">Mô tả:</label>
                    <textarea id="description" name="description"></textarea>
                    <span class="form-message"></span>
                </div>

                <div class="form-group">
                    <label for="avatar">Ảnh đại diện:</label>
                    <input
                        type="file"
                        id="avatar"
                        name="avatar"
                        accept="avatar/gif, avatar/jpeg, avatar/png"
                    />
                    <span class="form-message"></span>
                </div>

                <div class="form-submit__btn">
                    <button class="form-submit">Thêm nhân viên</button>
                </div>
            </form>
        </div>
        <script src="./assets/js/validator.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0-alpha3/js/bootstrap.min.js"
            integrity="sha512-wOLiP6uL5tNrV1FiutKtAyQGGJ1CWAsqQ6Kp2XZ12/CvZxw8MvNJfdhh0yTwjPIir4SWag2/MHrseR7PRmNtvA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                Validator({
                    form: "#form-add-user",
                    formGroupSelector: ".form-group",
                    errorSelector: ".form-message",
                    rules: [
                        Validator.isRequired(
                            "#name",
                            "Vui lòng nhập tên đầy đủ của bạn"
                        ),
                        Validator.isEmail("#email"),
                        Validator.isRequired(
                            "#username",
                            "Vui lòng nhập tên người dùng của bạn"
                        ),
                        Validator.isPhoneNumber("#phone_number"),
                        Validator.minLength("#password", 6),
                        Validator.isRequired("#password_confirmation"),
                        Validator.isConfirmed(
                            "#password_confirmation",
                            function () {
                                return document.querySelector(
                                    "#form-add-user #password"
                                ).value;
                            },
                            "Mật khẩu nhập lại không chính xác"
                        ),
                    ],
                    onSubmit: function addUser() {
                        const name =
                            document.querySelector('input[name="name"]').value;
                        const email = document
                            .querySelector('input[name="email"]')
                            .value.toLowerCase();
                        const username = document.querySelector(
                            'input[name="username"]'
                        ).value;
                        const password = document.querySelector(
                            'input[name="password"]'
                        ).value;
                        const password_confirmation = document.querySelector(
                            'input[name="password_confirmation"]'
                        ).value;
                        const birth_date = document.querySelector(
                            'input[name="birth_date"]'
                        ).value;
                        const phone_number = document.querySelector(
                            'input[name="phone_number"]'
                        ).value;
                        const gender = document.querySelector(
                            'input[name="gender"]'
                        ).value;
                        const is_active =
                            document.getElementById("is_active").value;
                        const description =
                            document.getElementById("description").value;
                        const role_id =
                            document.getElementById("role_id").value;
                        const avatarInput = document.querySelector(
                            'input[name="avatar"]'
                        );
                        const avatar =
                            avatarInput.files.length > 0
                                ? avatarInput.files[0]
                                : null;

                        const authToken =
                            "5wYlmkDfIpSZpUzEN1viAbzc1ubmBMeaWYh26IAu";
                        const newUser = new FormData(); // create a new FormData object
                        newUser.append("username", username);
                        newUser.append("password", password);
                        newUser.append(
                            "password_confirmation",
                            password_confirmation
                        );
                        newUser.append("name", name);
                        newUser.append("birth_date", birth_date);
                        newUser.append("phone_number", phone_number);
                        newUser.append("role_id", role_id);
                        newUser.append("gender", gender);
                        newUser.append("is_active", is_active);
                        newUser.append("email", email);
                        newUser.append("description", description);

                        if (!avatar) {
                            newUser.append("avatar", "");
                        } else if (avatar.type.includes("image")) {
                            newUser.append("avatar", avatar, avatar.name);
                        }

                        fetch("http://training.mumesoft.com/api/users", {
                            method: "POST",
                            body: newUser, // use the FormData object as the body
                            headers: {
                                Authorization: `Bearer ${authToken}`,
                                Accept: "application/json",
                            },
                        })
                            .then((response) => {
                                if (!response.ok) {
                                    throw new Error(response.statusText);
                                }
                                return response.json();
                            })
                            .then((data) => {
                                alert("Tạo tài khoản thành công!");
                                window.location.href = "index.html";
                            })
                            .catch((error) => {
                                console.error(error);
                                alert(
                                    "Tài khoản đã tồn tại. Vui lòng chọn tên người dùng khác."
                                );
                            });
                    },
                });
            });
        </script>
    </body>
</html>
